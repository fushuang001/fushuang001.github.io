---
layout:         post
title:          ç”±äº ICP å¤‡æ¡ˆå¼•èµ·çš„ä¸€äº›ç½‘ç»œé—®é¢˜
subtitle:		åœ¨ä¸­å›½å¢ƒå†…æä¾›äº’è”ç½‘æœåŠ¡ï¼Œå¿…é¡»è¿›è¡Œ ICP å¤‡æ¡ˆ
date:           2022-10-09
author:         Forest
cover:          '/assets/img/post-bg-icp.png'
tags:           AWS, ICP, 80/443/8080
---

# ä»€ä¹ˆæ˜¯ ICP å¤‡æ¡ˆ  
æœ‰ä¸¤å±‚å«ä¹‰ï¼Œåˆ†åˆ«é’ˆå¯¹ AWS account ä»¥åŠ DNS domain nameã€‚  
1. é»˜è®¤æƒ…å†µä¸‹ï¼ŒAWS account ä¸‹æ‰€æœ‰èµ„æº (EC2, ALB ç­‰ï¼‰çš„ TCP 80/443/8080 ç«¯å£ï¼Œæ˜¯æ— æ³•é€šè¿‡äº’è”ç½‘/å…¬ç½‘è®¿é—®çš„ï¼Œåªèƒ½å¤Ÿä» VPC å†…ç½‘ã€æœ¬åœ°ç½‘ç»œ--VPN/Direct Connect ä¸“çº¿æ¥è®¿é—®ï¼›è‹¥éœ€è¦é€šè¿‡äº’è”ç½‘/å…¬ç½‘è®¿é—®ï¼Œåˆ™éœ€è¦è¿›è¡Œ AWS è´¦å·çº§åˆ« ICP å¤‡æ¡ˆï¼Œå‡çº§ä¸º [å®Œå…¨è®¿é—®è´¦æˆ·](https://docs.amazonaws.cn/aws/latest/userguide/fullaccessaccount1.html)ï¼›  
2. è‹¥é€šè¿‡ AWS æ¥æ‰˜ç®¡ç½‘ç«™ï¼Œæ¯”å¦‚ www.example.com è§£æåˆ° ALBï¼Œé‚£ä¹ˆ example.com é¡¶çº§åŸŸåå¿…é¡»åœ¨ [å·¥ä¿¡éƒ¨](https://beian.miit.gov.cn/) åš ICP å¤‡æ¡ˆ  

# å¦‚ä½•è¿›è¡Œ ICP å¤‡æ¡ˆ  
[AWS è´¦å·çš„ ICP å¤‡æ¡ˆ](https://www.amazonaws.cn/about-aws/china/?nc1=h_ls) å¯ä»¥è”ç³»è¥¿äº‘æ•°æ®æˆ–è€…å…‰ç¯æ–°ç½‘ï¼›  
é¡¶çº§åŸŸåå¤‡æ¡ˆï¼Œä¸€èˆ¬å¯ä»¥é€šè¿‡åŸŸåè´­ä¹°æ–¹ï¼ˆæ¯”å¦‚è…¾è®¯äº‘ï¼‰åšç”³è¯·ã€‚  

# å¦‚æœæ²¡æœ‰ ICP å¤‡æ¡ˆï¼Œå¯èƒ½é‡åˆ°ä»€ä¹ˆé—®é¢˜  
é‡åˆ°æ¯”è¾ƒå¥‡æ€ªçš„ç½‘ç»œé—®é¢˜ï¼Œæ¯”å¦‚ TCP 80/443/8080 ç«¯å£ä¸é€šï¼Œclient é€šè¿‡ HTTPS è®¿é—®ç½‘ç«™ä½†æ˜¯ SSL/TLS åå•†å¤±è´¥ï¼Œå¯ä»¥è€ƒè™‘ä¸€ä¸‹ ICPã€‚  
è´´ä¸€æ®µ Wireshark æŠ“åŒ…ï¼ˆæ–¹ä¾¿éšå»å®¢æˆ·çœŸå® IP)ï¼Œå…³æ³¨ client å‘é€`Client Hello`ä¹‹åï¼Œserver ç«¯ç«‹åˆ»å›åº”äº† `RST`ï¼Œå¹¶ä¸”é™„åŠ äº†ä¸€ä¸ª `HTTP/1.1 403 Forbidden`é¡µé¢ã€‚  

![ç½‘ç«™æš‚æ—¶æ— æ³•è®¿é—®](/assets/img/post-non-icp-block.png)      

```
1	2022-09-29 07:40:11.194476	10.1.2.3	101.1.1.101	TCP	66	0x9f38 (40760)	52226 â†’ 443 [SYN] Seq=0 Win=64896 Len=0 MSS=1352 WS=256 SACK_PERM=1
2	2022-09-29 07:40:11.367928	101.1.1.101	10.1.2.3	TCP	66	0x0000 (0)	443 â†’ 52226 [SYN, ACK] Seq=0 Ack=1 Win=26883 Len=0 MSS=1460 SACK_PERM=1 WS=256
3	2022-09-29 07:40:11.368061	10.1.2.3	101.1.1.101	TCP	54	0x9f39 (40761)	52226 â†’ 443 [ACK] Seq=1 Ack=1 Win=262144 Len=0
4	2022-09-29 07:40:11.368646	10.1.2.3	101.1.1.101	TLSv1	571	0x9f3a (40762)	Client Hello
5	2022-09-29 07:40:11.539352	101.1.1.101	10.1.2.3	TCP	54	0x0000 (0)	443 â†’ 52226 [RST] Seq=1 Win=0 Len=0
6	2022-09-29 07:40:11.540130	10.1.2.3	101.1.1.101	TCP	66	0x9f3b (40763)	52227 â†’ 443 [SYN] Seq=0 Win=64896 Len=0 MSS=1352 WS=256 SACK_PERM=1
7	2022-09-29 07:40:11.668866	101.1.1.101	10.1.2.3	HTTP	681	0x9f3b (40763)	HTTP/1.1 403 Forbidden  (text/html)

Line-based text data: text/html (15 lines)
    <html>\n
    <head>\n
    <meta http-equiv="Content-Type" content="textml;charset=UTF-8" />\n
       <style>body{background-color:#FFFFFF}</style> \n
    <title>zhy54-144 éæ³•é˜»æ–­</title>\n
      <script language="javascript" type="text/javascript">\n
             window.onload = function () { \n
               document.getElementById("mainFrame").src= "http://203.93.170.219:9080/error.html"; \n
                }\n
    </script>   \n
    </head>\n
      <body>\n
          <iframe id="mainFrame" src="" frameborder="0" width="100%" height="100%"></iframe>\n
      </body>\n
    </html>

```

## AWS account ä¸‹æ‰€æœ‰èµ„æºçš„ TCP 80/443/8080 ç«¯å£ä¸é€š  
client --- Internet -- ALB(Listener 80/443/8080)ï¼Œclient æ— æ³•è®¿é—® AWS èµ„æºçš„ TCP 80/443/8080 æœåŠ¡ï¼Œä» client ç«¯è§‚å¯Ÿåˆ°çš„ç°è±¡ä¸ä¸€ï¼Œå¯èƒ½ timeoutï¼Œå¯èƒ½ SSL/TLS åå•†å¤±è´¥ç­‰ã€‚  
ä¹Ÿæœ‰å¯èƒ½æœ€åˆ client request å¹¶æ²¡æœ‰è¢«è¯†åˆ«/æ‹¦æˆªï¼Œæµ‹è¯•ä¸Šçº¿ä¹‹åæ‰è¢«è¯†åˆ«/æ‹¦æˆªï¼Œè¯´ä¸å®šå°±æ˜¯ç”Ÿäº§äº‹æ•…äº† ğŸ˜‚ ã€‚    

## ELB æ‰˜ç®¡çš„ç½‘ç«™ï¼Œæ— æ³•é€šè¿‡ HTTPS è®¿é—®  
é€šè¿‡ ELB æ‰˜ç®¡ç½‘ç«™æœåŠ¡ï¼Œå¦‚æœç½‘ç«™æä¾› HTTPS è®¿é—®ï¼Œé‚£ä¹ˆéœ€è¦åœ¨ ELB é…ç½®å¯¹åº”çš„ç½‘ç«™è¯ä¹¦ï¼›  
[NLB çš„ TLS listener](https://docs.amazonaws.cn/elasticloadbalancing/latest/network/create-tls-listener.html) ä»¥åŠ [ALB çš„ HTTPS listener](https://docs.amazonaws.cn/elasticloadbalancing/latest/application/create-https-listener.html)ï¼Œéƒ½æ”¯æŒ `SAN(Subject Alternative Name)`, `SNI(Server Name Indication)`ï¼›  
å¯¹äº ALB æ¥è¯´è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼ŒHTTPS listener çš„é»˜è®¤è¯ä¹¦æ˜¯åœ¨ client ä¸æ”¯æŒ SNIï¼Œæˆ–è€… `Client Hello` æŠ¥æ–‡çš„ SNI å¹¶ä¸åŒ¹é…ä»»ä½•å…¶ä»–è¯ä¹¦æƒ…å†µä¸‹æ‰ä¼šä½¿ç”¨ï¼›è‹¥ default certificate å¹¶ä¸åŒ…å« client æ‰€è®¿é—®çš„ domain nameï¼Œé‚£ä¹ˆ SSL/TLS åå•†ä¼šå¤±è´¥ï¼›  

## å°† public IP åœ°å€æ®µç”¨äºç§ç½‘ç¯å¢ƒï¼Œè®¿é—® AWS resource 80/443/8080 å¤±è´¥  
å¸¸è§çš„ [ç§ç½‘åœ°å€æ®µ](https://docs.amazonaws.cn/vpc/latest/userguide/configure-your-vpc.html) å¦‚ä¸‹ï¼ŒæŸäº›æƒ…å†µä¸‹å®¢æˆ·å¯èƒ½åœ¨æœ¬åœ°ç½‘ç»œé…ç½®äº†å…¶ä»–åœ°å€æ®µæ¯”å¦‚ 101.101.0.0/10 å½“ä½œç§ç½‘ä½¿ç”¨ï¼Œå¹¶ä¸”å€ŸåŠ© VPN æˆ–è€… Direct Connect ä¸“çº¿ï¼Œæ‰“é€šæœ¬åœ°ä¸ AWS VPC ç½‘ç»œï¼›  
å½“æœ¬åœ°ç½‘ç»œå°è¯•è®¿é—® AWS VPC èµ„æºçš„ TCP 80/443/8080 æœåŠ¡ï¼Œä¼šé‡åˆ°é—®é¢˜ï¼›å› ä¸º AWS ä¼šå°†éç§ç½‘ç½‘æ®µçš„æµé‡åˆ¤å®šä¸ºå…¬ç½‘è®¿é—®ï¼Œè¿›è€Œå› ä¸º AWS è´¦å·æ²¡æœ‰åš ICPï¼Œæˆ–è€… domain name æ²¡æœ‰ ICP å¤‡æ¡ˆï¼Œè¿›è¡Œæµé‡æ‹¦æˆªã€‚  
```
10.0.0.0/8
100.64.0.0/10
172.16.0.0/12
192.168.0.0/16
```
